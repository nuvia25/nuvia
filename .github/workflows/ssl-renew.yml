name: SSL Renew (Laravel Wildcard)

on:
  schedule:
    - cron: '17 3 * * *' # Diariamente Ã s 03:17 UTC
  workflow_dispatch:

jobs:
  renew:
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      - name: Check SSL configuration
        id: ssl_check
        run: |
          if [ -n "${{ secrets.CERTBOT_EMAIL }}" ] && [ -n "${{ secrets.CLOUDFLARE_TOKEN }}" ]; then
            echo "ssl_configured=true" >> $GITHUB_OUTPUT
            echo "ğŸ”’ SSL configurado - prosseguindo com renovaÃ§Ã£o"
          else
            echo "ssl_configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ SSL nÃ£o configurado - pulando renovaÃ§Ã£o"
          fi

      - name: Test certificate renewal (dry-run)
        if: steps.ssl_check.outputs.ssl_configured == 'true'
        run: |
          echo "ğŸ§ª Testando renovaÃ§Ã£o dos certificados (dry-run)..."
          ssh -o StrictHostKeyChecking=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ secrets.APP_PATH }} && \
             CLOUDFLARE_TOKEN='${{ secrets.CLOUDFLARE_TOKEN }}' \
             make ssl-test"
          echo "âœ… Teste de renovaÃ§Ã£o bem-sucedido"

      - name: Renew SSL certificates
        if: steps.ssl_check.outputs.ssl_configured == 'true'
        run: |
          echo "ğŸ”„ Renovando certificados SSL wildcard..."
          ssh -o StrictHostKeyChecking=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ secrets.APP_PATH }} && \
             CLOUDFLARE_TOKEN='${{ secrets.CLOUDFLARE_TOKEN }}' \
             make ssl-renew"
          echo "âœ… Certificados renovados com sucesso"

      - name: Verify SSL status after renewal
        if: steps.ssl_check.outputs.ssl_configured == 'true'
        run: |
          echo "ğŸ“Š Verificando status dos certificados..."
          ssh -o StrictHostKeyChecking=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ secrets.APP_PATH }} && make ssl-status"

      - name: Test HTTPS connectivity
        if: steps.ssl_check.outputs.ssl_configured == 'true'
        run: |
          sleep 10  # Aguardar nginx reload
          DOMAIN='${{ secrets.DOMAIN_NAME }}'
          
          echo "ğŸŒ Testando conectividade HTTPS pÃ³s-renovaÃ§Ã£o..."
          
          # Teste HTTPS principal
          if curl -fsS -m 20 --retry 2 --retry-delay 5 -L "https://$DOMAIN" -o /dev/null 2>&1; then
            echo "âœ… HTTPS principal: OK"
          else
            echo "âš ï¸ HTTPS principal: Problema detectado"
          fi
          
          # Teste wildcard
          if curl -fsS -m 20 --retry 2 --retry-delay 5 -L "https://app.$DOMAIN" -o /dev/null 2>&1; then
            echo "âœ… Wildcard SSL: OK"
          else
            echo "âš ï¸ Wildcard SSL: Problema detectado"
          fi

      - name: Backup certificates
        if: steps.ssl_check.outputs.ssl_configured == 'true'
        run: |
          echo "ğŸ’¾ Criando backup dos certificados..."
          ssh -o StrictHostKeyChecking=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ secrets.APP_PATH }} && make ssl-backup"
          echo "âœ… Backup dos certificados criado"

      - name: Log renewal completion
        if: steps.ssl_check.outputs.ssl_configured == 'true'
        run: |
          echo "ğŸ‰ RenovaÃ§Ã£o SSL concluÃ­da com sucesso!"
          echo "ğŸ“… PrÃ³xima renovaÃ§Ã£o automÃ¡tica: $(date -d '+30 days')"
          echo "ğŸŒ Certificado wildcard vÃ¡lido para: *.${{ secrets.DOMAIN_NAME }}"

      - name: Skip renewal notification
        if: steps.ssl_check.outputs.ssl_configured == 'false'
        run: |
          echo "â„¹ï¸ RenovaÃ§Ã£o SSL pulada - SSL nÃ£o configurado"
          echo "ğŸ’¡ Para habilitar: configure CERTBOT_EMAIL e CLOUDFLARE_TOKEN nos secrets"

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_rsa ~/.ssh/id_ed25519 ~/.ssh/known_hosts